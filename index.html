<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebAssembly Terminal Example</title>
    <!-- 引入 xterm.js 的样式 -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/xterm/5.5.0/xterm.min.css">
    <style>
        /* 设置终端容器样式 */
        #terminal {
            width: 100%;
            height: 300px;
            background: #1E1E1E; /* 暗色背景 */
            padding: 10px;
        }
        /* 设置按钮样式 */
        #upload-button {
            margin-top: 10px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- 文件上传按钮 -->
    <input type="file" id="upload-button" />

    <!-- 终端容器 -->
    <div id="terminal"></div>

    <!-- 引入 xterm.js 核心库 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/xterm/5.5.0/xterm.js"></script>
    <!-- 引入 Emscripten 生成的 JavaScript 胶水代码 -->
    <script src="cremu.js"></script>

    <script>
        // 初始化终端
        const terminal = new Terminal({
            fontSize: 14,
            cursorBlink: true,
            theme: {
                background: '#1E1E1E',  // 暗色背景
                foreground: '#FFFFFF'   // 白色文字
            }
        });
        // 2. 将终端挂载到页面上的 div 容器
        terminal.open(document.getElementById('terminal'));

        // 3. 显示欢迎信息
        terminal.writeln('Hello! 这是一个简单的终端示例');
        terminal.writeln('尝试输入文字，按下回车会回显内容~');

        // 4. 处理用户输入（简单回显功能）
        terminal.onData(data => {
            if (data === '\r') { // 检测回车键
                terminal.writeln(''); // 换行
            } else {
                terminal.write(data); // 回显输入
            }
        });

        // 5. 文件上传功能
        const uploadButton = document.getElementById('upload-button');
        uploadButton.addEventListener('change', (event) => {
            const file = event.target.files[0]; // 获取用户选择的文件
            if (file) {
                terminal.writeln(`\n已选择文件: ${file.name}`); // 显示文件名

                const reader = new FileReader();
                reader.onload = () => {
                    const arrayBuffer = reader.result;
                    const uint8Array = new Uint8Array(arrayBuffer);

                    // 将文件内容传递给 C 函数
                    Module.ccall(
                        'machine_start', // C 函数名
                        null,                // 返回值类型（void）
                        ['array', 'number'], // 参数类型（数组和大小）
                        [uint8Array, uint8Array.length] // 参数值
                    );

                    (function step() {
                        Module.ccall('machine_step', null, [], []);  // 执行目标函数
                        setTimeout(step, 0);  // 立即安排下一次执行
                    })();
                };
                reader.readAsArrayBuffer(file);
            } else {
                terminal.writeln('\n未选择文件');
            }
        });

        // 提供给 WebAssembly 调用的函数：向终端输出字符
        window.putCharToTerminal = (char) => {
            terminal.write(String.fromCharCode(char));
        };
    </script>
</body>
</html>
